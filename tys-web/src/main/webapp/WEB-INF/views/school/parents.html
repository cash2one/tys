<!-- 以下内容将在导航条上通过jquery动态加载，实现局部刷新 -->
<section class="content-header">
	<h1>家长管理</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> 首页</a></li>
		<li class="active">学校</li>
		<li class="active">家长管理</li>
	</ol>
</section>

<section class="content">
	<div class="row">
		<div class="col-md-12">
			<div class="box box-info">
				<div class="box-header with-border">
					<h3 class="box-title">家长列表</h3>
				</div>
				<div class="box-body">
					<div class="row">
						<div class="col-md-3">
							<div class="form-group">
								<label>省分</label> <select id="common_province"
									class="form-control">
								</select>
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label>城市</label> <select id="common_city" class="form-control">
								</select>
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label>区县</label> <select id="common_area" class="form-control">
								</select>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-3">
							<div class="form-group">
								<label>学生学校名称</label> <select id="school_id"
									class="form-control">
									<option selected="selected" disabled="disabled">选择学校名称</option>
								</select>
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label>家长姓名</label> <input type="text" class="form-control"
									placeholder="请输入家长姓名"> </select>
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label>家长手机号码</label> <input type="text" class="form-control"
									placeholder="请输入家长手机号码">
							</div>
						</div>
						<div class="col-md-2">
							<div class="form-group">
								<label>&nbsp;</label> <a
									class="form-control btn btn-social btn-info"> <i
									class="fa fa-search"></i> 查询
								</a>
							</div>
						</div>
					</div>
				</div>

				<div class="box-footer">
					<div class="row">
						<div class="col-sm-2">
							<div class="form-group">
								<a class="form-control btn btn-social btn-danger"> <i
									class="fa fa-trash"></i> 批量删除
								</a>
							</div>
						</div>
						<div class="col-sm-2">
							<div class="form-group">
								<a class="form-control btn btn-social btn-success"> <i
									class="fa fa-file-excel-o"></i> 批量导入
								</a>
							</div>
						</div>
						<!-- <div class="col-sm-1">
							<a class="btn btn-social btn-success"> <i class="fa fa-plus"></i>
								添加
							</a>
						</div> -->
					</div>

					<div class="row">
						<div class="col-sm-12" style="padding: 20px;">
							<table id="parent_table"
								class="table table-bordered table-hover table-striped">
								<thead>
									<tr>
									<th class="center" width="5%"><label> <input
											type="checkbox" class="ace" id="selectAll" /> <span
											class="lbl"></span>
									</label></th>
										<th>家长姓名</th>
										<th>家长电话</th>
										<th>家长性别</th>
										<th>所在城市</th>
										<th>学生信息</th>
										<!-- <th>初始化密码</th> -->
										<!-- <th>操作</th> -->
									</tr>
								</thead>
							</table>
						</div>
					</div>

					<div class="container">
						<div id="editModal" class="modal modal-info" aria-hidden="true">
							<div class="modal-dialog">
								<div class="modal-content">
									<div class="modal-header">
										<a class="close" data-dismiss="modal">×</a>
										<h4>编辑</h4>
									</div>
									<div class="modal-body">
										<form class="form-horizontal" role="form">
											<div class="form-group">
												<label for="name" class="col-sm-2 control-label">家长姓名</label>
												<div class="col-sm-10">
													<div class="input-group">
														<div class="input-group-addon">
															<i class="fa fa-user"></i>
														</div>
														<input id="name" type="text" class="form-control">
													</div>
												</div>
											</div>
											<div class="form-group">
												<label for="phone" class="col-sm-2 control-label">家长手机</label>
												<div class="col-sm-10">
													<div class="input-group">
														<div class="input-group-addon">
															<i class="fa fa-phone"></i>
														</div>
														<input id="phone" type="text" class="form-control">
													</div>
												</div>
											</div>
											<div class="form-group">
												<label for="phone" class="col-sm-2 control-label">出生日期</label>
												<div class="col-sm-10">
													<div class="input-group">
														<div class="input-group-addon">
															<i class="fa fa-calendar"></i>
														</div>
														<input type="text" class="form-control" id="birthday">
													</div>
												</div>
											</div>
											<div class="form-group">
												<label class="col-sm-2 control-label">家长性别</label>
												<div class="col-sm-10">
													<div class="radio">
														<label> <input type="radio" name="sex" value="0">
															男&nbsp;&nbsp;&nbsp;&nbsp;
														</label> <label> <input type="radio" name="sex" value="1">
															女
														</label>
													</div>
												</div>
											</div>
										</form>
									</div>
									<div class="modal-footer">
										<a href="#" class="btn btn-success">确认</a> <a href="#"
											class="btn btn-default" data-dismiss="modal">取消</a>
									</div>
								</div>
							</div>
						</div>

						<div id="deleteModal" class="modal modal-warning"
							aria-hidden="true">
							<div class="modal-dialog">
								<div class="modal-content">
									<div class="modal-header">
										<a class="close" data-dismiss="modal">×</a>
										<h4>警告</h4>
									</div>
									<div class="modal-body">
										<p>你确定要删除这条信息吗？</p>
									</div>
									<div class="modal-footer">
										<a id="del" href="#" class="btn btn-danger">确认</a> <a href="#"
											class="btn btn-default" data-dismiss="modal">取消</a>
									</div>
								</div>
							</div>
						</div>

						<div id="studentModal" class="modal" aria-hidden="true">
							<div class="modal-dialog">
								<div class="modal-content">
									<div class="modal-header">
										<a class="close" data-dismiss="modal">×</a>
										<h4>学生信息</h4>
									</div>
									<div class="modal-body">
										<table id="student_table"
											class="table table-bordered table-hover table-striped">
											<thead>
												<tr>													
													<th>学生姓名</th>
													<th>学生性别</th>
													<th>所属班级</th>
													<th>出生日期</th>									
												</tr>
											</thead>
										</table>
									</div>
									<div class="modal-footer">
										<a href="#" class="btn btn-default" data-dismiss="modal">关闭</a>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>

<script>
	var USER, ID;
	$(function() {
		initAddrElement();
		
		$("#selectAll").on('click',function(){
			var that = this;
			$("input[name='checkbox']").each(function(){
				var v = $(that)[0].checked;
				$(this)[0].checked=v;
			});
		});
		
		var t = $('#parent_table')
				.DataTable(
						{
							language : {
								url : '${base}/resources/dist/json/DataTableCN.json'
							},
							pagingType : "full_numbers",
							paging : true, //是否分页。
							processing : true, //当datatable获取数据时候是否显示正在处理提示信息。 
							serverSide : true,
							searching : false,
							ordering : false,
							ajax : {
								url : 'getparentlist'
							},
							//必须与table thead中按顺序一一对应
							columns : [
									{//用户账号
										data : 'id',
									},
									{//姓名
										data : 'name'
									},
									{//电话
										data : 'phone'
									},
									{//性別
										data : function(row, type, set) {
											return row.sex==1?"女":"男";
										}
									},
									{//所在城市
										data : 'cityCode'
									},
									{//学生信息
										data : function(row, type, set) {
											return "<a data-toggle='modal' onclick='initStudentTable("+row.id+")' href='#studentModal' class='btn btn-info btn-xs'>详情</a>";
										}
									}/* ,
									{//操作
										data : function(row, type, set) {
											return "<a data-toggle='modal' href='#editModal' class='btn btn-success btn-xs'>修改</a>&nbsp;&nbsp;<a data-toggle='modal' href='#deleteModal' onclick='rememberId("
													+ row.id
													+ ")' class='btn btn-danger btn-xs'>删除</a>";
										}
									} */],
									columnDefs:[{
										targets: 0,
							            data: "id",
							            render: function (data, type, full, meta) {
							            	return '<input type="checkbox" value="' + data + '" title="' + data + '" id="checkbox" name="checkbox"/>';
							            }
									}]
						});
		//初始化编辑模态框的出生日期
		$("#birthday").daterangepicker({
			'singleDatePicker' : true,
			autoclose : true
		});

		//初始化编辑模态框的手机号码
		$("#phone").inputmask("999 9999 9999", {
			"placeholder" : "xxx xxxx xxxx"
		});

		//删除一个家长信息
		var del = $('#del').click(function() {
			AjaxUtils('deleteparent', 'GET', 'id=' + ID, function(data) {
				if (data.msg == 0) {
					alert("删除数据失败！");
				}
				t.fnDraw();
				$('#deleteModal').modal('hide');
			});
		});

		$('#common_area').on('change', function() {
			initSchoolCombobox();
		});
	});

	//点击删除时记住要删除的家长ID
	function rememberId(obj) {
		ID = obj;
	}

	function initSchoolCombobox() {
		var province = $('#common_province option:selected').val();
		var city = $('#common_city option:selected').val();
		var area = $('#common_area option:selected').val();

		var url = "getschoollist";
		var param = "province=" + province + "&city=" + city + "&area=" + area;

		if (province != null && city != null && area != null) {
			AjaxUtils(url, 'GET', param, function(data) {
				if (data) {
					$("#school_id").get(0).options.length = 0;
					for (var i = 0; i < data.data.data.length; i++) {
						$("#school_id").get(0).options.add(new Option(
								data.data.data[i].name, data.data.data[i].schoolId));
					}
					;
				}
			});
		}
	}
	
	function initStudentTable(userId){
		$('#student_table').dataTable().fnDestroy();
		var stuTable = $('#student_table').dataTable({
					language : {
						url : '${base}/resources/dist/json/DataTableCN.json'
					},
					dom:'t',
					pagingType : "full_numbers",
					paging : false, //是否分页。
					processing : true, //当datatable获取数据时候是否显示正在处理提示信息。 
					serverSide : true,
					searching : false,
					ordering : false,
					ajax : {
						url : 'getstudentlist?userId='+userId
					},
					//必须与table thead中按顺序一一对应
					columns : [
							{//用户姓名
								data : 'name'
							},
							{//性別
								data : function(row, type, set) {
									if (row.sex == 1) {
										return "女";
									} else {
										return "男";
									}
								}
							},
							{//班级
								data : 'className'
							},
							{
								data : function(row,type,set){
									var birthday=new Date(row.birthday);
									return birthday.format("yyyy年MM月dd日")
								}
							}]
				});
	}
</script>