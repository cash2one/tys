<section class="content-header">
	<h1>
		班级管理 <small></small>
	</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
		<li class="active">班级信息</li>
	</ol>
</section>

<section class="content">
	<div class="row">
		<div class="col-md-12">
			<div class="box box-info">
				<div class="box-header with-border">
					<h3 class="box-title">班级信息管理</h3>
				</div>
				<div class="box-body">
					<form id="searchForm" role="form">
						<div class="row">
							<div class="col-md-3">
								<div class="form-group">
									<label>省</label>
									<input type="hidden" name="addrCodeMind" title="设置查询时其地域信息所属主体" value="school"/>
									<select id="common_province" name="s_province" class="form-control">
									</select>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label>市</label>
									<select id="common_city" name="s_city" class="form-control">
									</select>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label>区</label>
									<select id="common_area" name="s_area" class="form-control">
									</select>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label>学校名称</label>
									<input type="text" name="s_schoolName" class="form-control"  placeholder="请输入学校名称">
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label>班级名称：</label>
									<input type="text" name="s_name" class="form-control"  placeholder="请输入班级名称">
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label>班主任姓名：</label>
									<input type="text" name="s_teacherName" class="form-control"  placeholder="请输入班级名称">
								</div>
							</div>
							<div class="col-sm-2">
								<div class="form-group">
									<label></label>
									<a id="search" class="btn btn-block btn-social btn-info">
										<i class="fa fa-search"></i> 查询
									</a>
								</div>
							</div>
						</div>
					</form>
				</div>
				<div class="box-footer">
					<div class="row">
						<div class="col-sm-2">
							<a class="btn btn-block btn-social btn-info disabled">
								<i class="fa fa-trash"></i> 批量导入
							</a>
						</div>
						<div class="col-sm-2">
							<a class="btn btn-block btn-social btn-success"  data-toggle="modal" href="#myModal" onclick="initvalue();">
								<i class="fa fa-plus"></i> 添加
							</a>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12" style="padding: 20px;">
							<table id="class_table" class="table table-bordered table-hover table-striped">
								<thead>
									<tr>
										<th class="center" width="5%">
											<label>
												<input type="checkbox" class="ace" id="selectAll"/>
												<span class="lbl"></span>
											</label>
										</th>
										<th width="80px">班级名称</th>
										<th width="120px">学校</th>
										<th width="80px">年级</th>
										<th width="150px">所属地区</th>
										<th width="80px">学生人数</th>
										<th width="80px">班主任</th>
										<th width="80px">入学年份</th>
										<th width="120px">创建时间</th>
										<th width="80px">任教老师</th>
										<th width="80px">操作</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>
				</div><!-- box-footer end -->
			</div>
		</div>
	</div>
	
	<!-- Modal -->
	<div id="myModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
	  		<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
					<h4 class="modal-title" id="myModalLabel">添加班级信息</h4>
				</div>
				<div class="modal-body">
					<form id="add-form" class="form-horizontal add-form" role="form" method="post" action="../sys/mergeclass">
						<input type="hidden" name="editid" value='0'/>
						<div class="form-group">
							<label for="className" class="col-sm-3 control-label">班级名称</label>
							<div class="col-sm-6">
								<div class="input-group">
									<div class="input-group-addon">
										<i class="fa fa-user"></i>
									</div>
									<input name="className" type="text" class="form-control">
								</div>
							</div>
						</div>
						<div class="form-group" id="province">
							<label class="col-sm-3 control-label">学校</label>
							<div class="col-sm-6">
								<select name="schoolId" id="schoolId" data-placeholder="请选择学校" style="width: 100%" class="form-control select2">
								</select>
							</div>
						</div>
						<div class="form-group" id="province">
							<label class="col-sm-3 control-label">年级</label>
							<div class="col-sm-6">
								<select name="gradeId" id="gradeId" data-placeholder="请选择年级" style="width: 100%" class="form-control select2">
								</select>
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-3 control-label">入学年份</label>
							<div class="col-sm-6">
								<div class="input-group">
									<div class="input-group-addon">
										<i class="fa fa-home"></i>
									</div>
									<input type="text" class="form-control" name="year">
								</div>
							</div>
						</div>
						<div class="form-group" id="province">
							<label class="col-sm-3 control-label">班主任</label>
							<div class="col-sm-6">
								<select name="adminId" id="adminId" data-placeholder="请选择班主任" style="width: 100%" class="form-control select2">
								</select>
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
				  	<button type="button" id="add" class="btn btn-small btn-primary">提交</button>
				  	<button type="button" id="cancel" class="btn btn-small btn-danger" data-dismiss="modal">取消</button>
				</div>
			</div>
		</div>
	</div><!--PAGE CONTENT ENDS-->
	
	<div id="infoModal" class="modal modal-info" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<a class="close" data-dismiss="modal">×</a>
					<h4 id="info_title">提示</h4>
				</div>
				<div class="modal-body">
					<p id="msg"></p>
				</div>
				<div class="modal-footer">
					<a href="#" class="btn btn-default" data-dismiss="modal">关闭</a>
				</div>
			</div>
		</div>
	</div>
					
</section>

<script type="text/javascript">
var rowHash={};
var table;
$(function() {
	initAddrElement();
	initTeacherSelect('adminId');
	initSchoolSelect('schoolId');
	initGradeSelect('gradeId');
	
	table = initDataTable('getclassedt');
	
	$("#selectAll").on('click',function(){
		var that = this;
		$("input[name='checkbox']").each(function(){
			var v = $(that)[0].checked;
			$(this)[0].checked=v;
		});
	});
	
	$(document).keyup(function(event){
		if(event.keyCode ==13){
			$("#search").trigger("click");
		}
	});
	
	/*搜索*/
	$("#search").click(function() {
		var param = $("#searchForm").serialize();
		var url = 'getclassedt?'+param+'&t='+(new Date().getTime());
		table.ajax.url(url).load();
		//table.fnDestroy();
		//table = initDataTable(url);
	});
	
	/**/
	$('#add').on('click', function() {
		var url ="../sys/mergeclass";
		var param = $('#add-form').serialize();
		
		if ($('#add-form').valid()) {
			AjaxUtils(url,'POST',param,function(data){
				if(data){
					data = jQuery.parseJSON(data);
		    		//$("#notice-tip").show();
		    		//$("#notice-span").html(data.data.notice);
		    		
		    		if(data.data.result=="success"){
			    		$("#myModal").modal('hide');
		    		}
		    		alert(data.data.notice);
		    		
		    		//TODO 后期修改table刷新
		    		loadPage('getclass');
	     		}else{
	     			alert('操作失败！');
	     		}
			});
		}
	});
	
	var rules = {className : "required",
			schoolId : "required",
			gradeId : "required",
			year:{required:true}
			};
	var messages = {className:"请输入班级名称",schoolId:"请选择学校",gradeId:"请选择年级",year:"请输入入学年份"};
	var validator = validatorUtils('add-form',rules,messages);
	
	//初始化编辑模态框的年份
	$("#year").inputmask("9999", {
		"placeholder" : "xxxx"
	});
	
	//添加模态框隐藏后触发改事件
	$('#myModal').on('hide.bs.modal',function(){
		//清除验证错误信息
		validator.resetForm();
		//清空表单数据
		$('#add-form').get(0).reset();
		
		//清除错误信息残留样式
		$('#myModal .form-group').removeClass("has-error has-success has-feedback");
		$('#myModal .form-group').find("span").removeClass("glyphicon-ok glyphicon-remove");
	});
});

function initDataTable(url){
	var id="class_table";
	var columns = [{//多选框
		data: "id"
	}, {//班级名称
		data: function(row, type, set){
				return row.className;
		},
		defaultContent : ''
	}, {//学校名称
		data: function(row, type, set){
			if (row.hasOwnProperty("mdSchool"))
				return row.mdSchool.name;
			else
				return "";
		},
		defaultContent : ''
	}, {//年级名称
		data: function(row, type, set){
			if (row.hasOwnProperty("mdGrade"))
				return row.mdGrade.name;
			else
				return '';
		},
		defaultContent : ''
	}, {//所属区域
		data: function(row, type, set){
			if (row.hasOwnProperty("mdSchool"))
				return row.mdSchool.dProvince.name+"-"+row.mdSchool.dCity.name+"-"+row.mdSchool.dArea.name;
			else
				return "";
		},
		defaultContent : ''
	}, {//学生人数
		data: function(row, type, set) {
			return "";
		},
		defaultContent : ''
	}, {//班主任
		data: function(row, type, set) {
			if (row.hasOwnProperty("mdUser")){
				return row.mdUser.name;
			}else{
				return "";
			}
		},
		defaultContent : ''
	}, {//入学年份
		data: "year",
		defaultContent : ''
	}, {//创建时间
		data: function(row, type, set){
			var val = row.createTime;
			if(!val){
				return "";
			}else{
				var d = new Date(val);
				return d.format("yyyy-MM-dd hh:mm:ss");
			}
			return "";
		},
		defaultContent : ''
	/* }, {//家长信息
		data: function(row, type, set) {
			return '<input type="button" class="btn btn-info btn-sm" value="详情" onclick="fnShowModalParent('+row.id+')" />';
		} */
	}, {//任教老师信息
		data: function(row, type, set) {
			return '<input type="button" class="btn btn-info btn-sm" value="详情"  onclick="fnShowModalTeacher('+row.id+')" />';
		}
	}, {//操作
		data: function(row, type, set) {
			rowHash[row.id] = row;
        	return '<input type="button" data-toggle="modal" href="#myModal" onclick="setvalue(' + row.id + ')" class="btn btn-success btn-sm" value="修改" />&nbsp;&nbsp;<input type="button" onclick="removevalue(' + row.id + ')" class="btn btn-danger btn-sm" value="删除" />';
		},
	}];
	return initTable(id,url,columns);
}

function initvalue(){
	$("input[name='editid']").val(0);
	$('#add-form')[0].reset();
	$("#myModalLabel").html("添加班级信息");
}

function setvalue(id){
	initvalue();
	$("#myModalLabel").html("修改班级信息");
	var proIdArray = ["schoolId","gradeId"];
	var proNameArray = ["className","year"];
	$("input[name='editid']").val(id);
	var currentRow = rowHash[id];

	for(var i=0;i<proIdArray.length;i++){
		$("#"+proIdArray[i]).val(currentRow[proIdArray[i]]);
	}
	for(var i=0;i<proNameArray.length;i++){
		$("input[name='"+proNameArray[i]+"']").val(currentRow[proNameArray[i]]);
	}
	
	//处理特殊属性的值  "adminId"
	if(currentRow.hasOwnProperty("mdUser")){
		$("#adminId").val(currentRow.mdUser.id);
	}
	
}

function fnShowModalParent(id){
	var url='../sys/getparentsclass';
	fnShowModalBasic(id,url,'家长信息');
}
function fnShowModalTeacher(id){
	var url='../sys/getteachersclass';
	fnShowModalBasic(id,url,'任教老师');
}
function fnShowModalBasic(id,url,title){
	var param = 'classId='+id;
	AjaxUtils(url,'GET',param,function(data){
		if(data){
    		var objarry = data.data.users;
    		var msg='';
    		for(var i=0;i<objarry.length;i++){
    			if(i!=0){
    				msg=msg+"<br>";
    			}
    			var course=''
    			try{
    				course = objarry[i].mdCourse.name;
    			}catch(e){}
    			msg=msg+"姓名："+objarry[i].mdUser.name+",电话："+objarry[i].mdUser.phone+",课程："+course;
    		}
    		if(''==msg){
    			msg="未找到相关信息！";
    		}
    		$("#info_title").empty().append(title);
    		$("#msg").empty().append(msg);
			$("#infoModal").modal('show');
 		}else{
 			alert('操作失败！');
 		}
	});
}

function removevalue(id){
	var currentRow = rowHash[id];
	if(window.confirm('确认删除 '+currentRow.className+' ？')==true){
		var url='../sys/removeclass';
		var param = 'id='+id;
		AjaxUtils(url,'GET',param,function(data){
			if(data){
	    		//$("#notice-tip").show();
	    		//$("#notice-span").html(data.data.notice);
	    		
	    		alert(data.data.notice);
	    		
	    		table.ajax.reload();
	    		//loadPage('getclass');
     		}else{
     			alert('操作失败！');
     		}
		});
	}
}
</script>
