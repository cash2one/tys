<section class="content-header">
	<h1>
		学校管理 <small></small>
	</h1>
	<ol class="breadcrumb">
		<li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
		<li class="active">学校信息</li>
	</ol>
</section>

<section class="content">
	<div class="row">
		<div class="col-md-12">
			<div class="box box-info">
				<div class="box-header with-border">
					<h3 class="box-title">学校信息管理</h3>
				</div>
				<div class="box-body">
					<form id="searchForm" role="form">
						<div class="row">
							<div class="col-md-3">
								<div class="form-group">
									<label>省</label>
									<select id="common_province" name="s_province" class="form-control">
									</select>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label>市</label>
									<select id="common_city" name="s_city" class="form-control">
									</select>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label>区</label>
									<select id="common_area" name="s_area" class="form-control">
									</select>
								</div>
							</div>
							<div class="col-md-3">
								<div class="form-group">
									<label>学校名称</label>
									<input type="text" name="s_name" class="form-control"  placeholder="请输入学校名称">
								</div>
							</div>
							<!-- <div class="col-md-3">
								<div class="form-group">
									<label>学校地址</label>
									<input type="text" name="s_address" class="form-control"  placeholder="请输入学校地址">
								</div>
							</div> -->
							<div class="col-sm-2">
								<div class="form-group">
									<label></label>
									<a id="search" class="btn btn-block btn-social btn-info">
										<i class="fa fa-search"></i> 查询
									</a>
								</div>
							</div>
						</div>
					</form>
				</div>
				<div class="box-footer">
					<div class="row">
						<div class="col-sm-2">
							<a id="batchRemove" class="btn btn-block btn-social btn-danger disabled">
								<i class="fa fa-trash"></i> 批量删除
							</a>
						</div>
						<div class="col-sm-2">
							<a class="btn btn-block btn-social btn-success" data-toggle="modal" href="#myModal" onclick="initvalue();">
								<i class="fa fa-plus"></i> 添加
							</a>
						</div>
						<div class="col-sm-8" style="display:none;" id="notice-tip">
							<div class="alert alert-info">
								<button type="button" class="close" data-dismiss="alert">
									<i class="icon-remove"></i>
								</button>
								<i class="icon-ok"></i><strong id="notice-span"></strong>
							</div>
						</div>
					</div>

					<div class="row">
						<div class="col-sm-12" style="padding: 20px;">
							<table id="school_table" class="table table-bordered table-hover table-striped">
								<thead>
									<tr>
										<th class="center" width="10px">
											<label>
												<input type="checkbox" class="ace" id="selectAll"/>
												<span class="lbl"></span>
											</label>
										</th>
										<th width="80px">学校名称</th>
										<th width="80px">管理员账号</th>
										<th width="80px">电话</th>
										<th width="150px">所属地区</th>
										<th width="200px">详细地址</th>
										<th width="80px">负责人</th>
										<th width="80px">创建人</th>
										<th width="120px">创建时间</th>
										<th width="80px">操作</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

<!-- Modal -->
	<div id="myModal" class="modal fade" tabindex="-1" role="dialog"
		aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">
						<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
					</button>
					<h4 class="modal-title" id="myModalLabel">添加学校信息</h4>
				</div>
				<div class="modal-body">
					<form id="add-form" class="form-horizontal add-form" role="form" method="post" action="">
						<input type="hidden" name="adminId" value='0'/>
						<input type="hidden" name="editid" value="0" />
						<div class="form-group">
							<label for="name" class="col-sm-3 control-label">创建管理账号</label>
							<div class="col-sm-6">
								<div class="input-group">
									<div class="input-group-addon">
										<i class="fa fa-user"></i>
									</div>
									<input type="text" name="loginName" class="form-control"/>
								</div>
							</div>
							<span id="checkMsg" style="color: red;display: none;">此账号已经被使用！</span>
						</div>
						<div class="form-group">
							<label for="name" class="col-sm-3 control-label">学校名称</label>
							<div class="col-sm-6">
								<div class="input-group">
									<div class="input-group-addon">
										<i class="fa fa-user"></i>
									</div>
									<input id="names" name="name" type="text" class="form-control">
								</div>
							</div>
						</div>
						<div class="form-group">
							<label for="name" class="col-sm-3 control-label">负责人名称</label>
							<div class="col-sm-6">
								<div class="input-group">
									<div class="input-group-addon">
										<i class="fa fa-user"></i>
									</div>
									<input id="adminName" name="adminName" type="text" class="form-control">
								</div>
							</div>
						</div>
						<div class="form-group" id="pwd">
							<label for="password" class="col-sm-3 control-label">密码</label>
							<div class="col-sm-6">
								<div class="input-group">
									<div class="input-group-addon">
										<i class="fa fa-lock"></i>
									</div>
									<input id="password" name="password" type="password" class="form-control">
								</div>
							</div>
						</div>
						<div class="form-group" id="province">
							<label for="phone" class="col-sm-3 control-label">省份</label>
							<div class="col-sm-6">
								<select name="provinceId" id="provinceId" data-placeholder="请选择省份" style="width: 100%" class="form-control select2">
								</select>
							</div>
							<span id="provinceMsg" style="color: red; display: none;">请选择省份</span>
						</div>
						<div class="form-group" id="city">
							<label for="phone" class="col-sm-3 control-label">市级</label>
							<div class="col-sm-6">
								<select name="cityId" id="cityId" data-placeholder="请选择城市" style="width: 100%" class="form-control select2">
								</select>
							</div>
							<span id="cityMsg" style="color: red; display: none;">请选择城市</span>
						</div>
						<div class="form-group" id="area">
							<label for="phone" class="col-sm-3 control-label">地区</label>
							<div class="col-sm-6">
								<select name="areaId" id="areaId" data-placeholder="请选择区县" style="width: 100%" class="form-control select2">
								</select>
							</div>
							<span id="areaMsg" style="color: red; display: none;">请选择区县</span>
						</div>
						<div class="form-group">
							<label class="col-sm-3 control-label">学校地址</label>
							<div class="col-sm-6">
								<div class="input-group">
									<div class="input-group-addon">
										<i class="fa fa-home"></i>
									</div>
									<input type="text" class="form-control" id="address" name="address">
								</div>
							</div>
						</div>
						<div class="form-group">
							<label for="name" class="col-sm-3 control-label">电话</label>
							<div class="col-sm-6">
								<div class="input-group">
									<div class="input-group-addon">
										<i class="fa fa-phone"></i>
									</div>
									<input id="tel" name="tel" type="text" class="form-control">
								</div>
							</div>
						</div>
						<!-- <div class="form-group" id="area">
							<label for="phone" class="col-sm-3 control-label">短信开关</label>
							<div class="col-sm-6">
								<select name="messageFlag" data-placeholder="请选择短信开关" style="width: 100%" class="form-control select2">
									<option value="0">关闭</option>
									<option value="1">开通</option>
								</select>
							</div>
							<span id="areaMsg" style="color: red; display: none;">请选择短信开关</span>
						</div> -->
						<input name="messageFlag" type="hidden" value="1">
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" id="add" class="btn btn-small btn-success">提交</button>
					<button type="button" id="cancel" class="btn btn-small btn-danger" data-dismiss="modal">取消</button>
				</div>
			</div>
		</div>
	</div>
	
	<!--PAGE CONTENT ENDS-->
</section>

<script type="text/javascript">
var rowHash={};
var table;
$(function() {
	initAddrElement();
	
	table = initDataTable('getschooledt');
	
	$("#selectAll").on('click',function(){
		var that = this;
		$("input[name='checkbox']").each(function(){
			var v = $(that)[0].checked;
			$(this)[0].checked=v;
		});
	});
	
	$("#batchRemove").on('click',function(){
		var ids = '';
		var adminIds = '';
		$("input[name='checkbox']").each(function(index,item){
			var v = $(this)[0].checked;
			if(v==true){
				var id = $(this).val();
				var currentRow = rowHash[id];
				ids=ids+id+",";
				adminIds=adminIds+currentRow.adminId+",";
			}
		});
		
		if(ids.length<2){
			alert('请选择需要删除的学校');
			return false;
		}
		
		if(window.confirm('确认批量删除？')==true){
			var url='../sys/batchremoveschool';
			
			var param = 'ids='+ids+"&adminIds="+adminIds;
			AjaxUtils(url,'GET',param,function(data){
				if(data){
					data = jQuery.parseJSON(data);
		    		alert(data.data.notice);
		    		
		    		loadPage('getschool');
	     		}else{
	     			alert('操作失败！');
	     		}
			});
		}
	});
	
	$(document).keyup(function(event){
		if(event.keyCode ==13){
			$("#search").trigger("click");
		}
	});
	
	/*搜索学校*/
	$("#search").click(function() {
		var param = $("#searchForm").serialize();
		var url = 'getschooledt?'+param+'&t='+(new Date().getTime());
		table.ajax.url(url).load();
		//table.fnDestroy();
		//table = initDataTable(url);
	});
	
	/**/
	$('#add').on('click', function() {
		/*var adminAcct = $("input[name='loginName']").val();
		if(!adminAcct||adminAcct.length<6){
			alert("请输入正确的负责人账号最少六位！");
			return false;
		}*/
		
		if ($('#add-form').valid()) {
			var url ="../sys/mergeschool";
			var param = $('#add-form').serialize();
			AjaxUtils(url,'POST',param,function(data){
				if(data){
					data = jQuery.parseJSON(data);
		    		//$("#notice-tip").show();
		    		//$("#notice-span").html(data.data.notice);
		    		
		    		if(data.data.result=="success"){
			    		$("#myModal").modal('hide');
		    		}
		    		alert(data.data.notice);
		    		//TODO 后期修改table刷新
		    		loadPage('getschool');
	     		}else{
	     			alert('操作失败！');
	     		}
			});
		}
	});

	/*初始化省级列表*/
	var url = "getaddressjson";
	var param = "type=1";
	AjaxUtils(url, 'GET', param, function(data) {
		if (data) {
			$("#provinceId").get(0).options.length = 0;
			$("#provinceId").get(0).options.add(new Option("", ""));
			for (var i = 0; i < data.data.data.length; i++) {
				$("#provinceId").get(0).options.add(new Option(data.data.data[i].name, data.data.data[i].code));
			};
		}
	});
	
	/*获取市级列表*/
	$("#provinceId").on('change',function(){
		var provinceCode = $(this).val();
		if(!provinceCode)return false;
		var url ="../sys/getaddressjson";
		var param = "type=2&addrcode="+provinceCode;
		AjaxSynUtils(url,'GET',param,function(data){
			if(data){
	    		$("#cityId").get(0).options.length=0;
	    		for(var i = 0; i < data.data.data.length; i++){
	    			$("#cityId").get(0).options.add(new Option(data.data.data[i].name,data.data.data[i].code));
				};
				
				//$("#cityId").trigger('change');
     		}
		});
	});
	
	/*获取区县列表*/
	$("#cityId").on('change',function(){
		var provinceCode = $(this).val();
		if(!provinceCode)return false;
		var url ="../sys/getaddressjson";
		var param = "type=3&addrcode="+provinceCode;
		AjaxSynUtils(url,'GET',param,function(data){
			if(data){
	    		$("#areaId").get(0).options.length=0;
	    		for(var i = 0; i < data.data.data.length; i++){
	    			$("#areaId").get(0).options.add(new Option(data.data.data[i].name,data.data.data[i].code));
				};
    		}
		});
	});

	var rules = {loginName : "required",
				name : "required",
				adminName : "required",
				provinceId:{required:true},
				cityId:{required:true},
				areaId:{required:true},
				//password:{required:true, minlength : 6, maxlength : 64},
				address:{required:true, minlength : 2, maxlength : 64},
				tel : {required:true}
				//messageFlag:{required:true}
				};
	var messages = {name:"请输入学校名称",loginName:"请输入创建管理账号",tel:"请输入正确的电话号码",
				   address:{required:"请输入地址",minlength:"地址长度至少为2个字符",maxlength:"地址长度超过最大限制"},
				   password:{required:"请输入密码",minlength:"密码长度至少为6个字符",maxlength:"密码长度超过最大限制"}
				   };
	var validator = validatorUtils('add-form',rules,messages);
	
	//初始化编辑模态框的手机号码
	$("#tel").inputmask("99999999999", {
		"placeholder" : "xxxxxxxxxxx"
	});
	
	//添加模态框隐藏后触发改事件
	$('#myModal').on('hide.bs.modal',function(){
		//清除验证错误信息
		validator.resetForm();
		//清空表单数据
		$('#add-form').get(0).reset();
		
		//清除错误信息残留样式
		$('#myModal .form-group').removeClass("has-error has-success has-feedback");
		$('#myModal .form-group').find("span").removeClass("glyphicon-ok glyphicon-remove");
	});
});

function initDataTable(url){
	var id="school_table";
	var columns = [{//多选框
		data: "id"
	}, {//名称
		data: "name",
		defaultContent : ''
	}, {//管理员账号
		data: function(row, type, set) {
			if (row.hasOwnProperty("sysUser")){
				return row.sysUser.loginName;
			}else{
				return "";
			}
		},
		defaultContent : ''
	}, {//电话
		data: function(row, type, set) {
			return row.tel;
		},
		defaultContent : ''
	}, {//所属区域
		data: function(row, type, set){
			if (row.hasOwnProperty("dProvince")&&row.hasOwnProperty("dCity")&&row.hasOwnProperty("dArea"))
				return row.dProvince.name+"-"+row.dCity.name+"-"+row.dArea.name;
			else
				return "";
		},
		defaultContent : ''
	}, {//详细地址
		data: 'address',
		defaultContent : ''
	}, {//负责人信息
		data: "adminName",
		defaultContent : ''
	}, {//创建人
		data: function(row, type, set) {
			if (row.hasOwnProperty("sysUserCreate")){
				return row.sysUserCreate.name;
			}else{
				return "";
			}
		},
		defaultContent : ''
	}, {//创建时间
		data: function(row, type, set){
			var val = row.createTime;
			if(!val){
				return "";
			}else{
				var d = new Date(val);
				return d.format("yyyy-MM-dd hh:mm:ss");
			}
			return "";
		},
		defaultContent : ''
	}, {//操作
		data: function (row, type, set) {
			rowHash[row.id] = row;
        	return '<input type="button" data-toggle="modal" href="#myModal" onclick="setvalue(' + row.id + ')" class="btn btn-success btn-sm" value="修改"/>&nbsp;&nbsp;<input type="button" onclick="removevalue(' + row.id + ')" class="btn btn-danger btn-sm" value="删除" />';
        }
	}];
	
	return initTable(id,url,columns)
}

function initvalue(){
	$("#myModalLabel").html("添加学校信息");
	$("input[name='editid']").val(0);
	$('#add-form')[0].reset();
}

function setvalue(id){
	initvalue();
	$("#myModalLabel").html("修改学校信息");
	
	var proIdArray = ["provinceId","cityId","areaId"];
	var proNameArray = ["name","adminId","address","tel"];//,"messageFlag"
	$("input[name='editid']").val(id);
	var currentRow = rowHash[id];

	for(var i=0;i<proIdArray.length;i++){
		$("#"+proIdArray[i]).val(currentRow[proIdArray[i]]);
		if(proIdArray[i]=="provinceId"){
			$("#provinceId").trigger('change');
		}
		if(proIdArray[i]=="cityId"){
			$("#cityId").trigger('change');
		}
	}
	for(var i=0;i<proNameArray.length;i++){
		$("input[name='"+proNameArray[i]+"']").val(currentRow[proNameArray[i]]);
	}
	
	//处理特殊属性的值  "loginName","adminName"
	$("input[name='loginName']").val(currentRow.sysUser.loginName);
	//$("input[name='password']").val(currentRow.sysUser.password);
	$("input[name='adminName']").val(currentRow.sysUser.name);
}

function removevalue(id){
	var currentRow = rowHash[id];
	if(window.confirm('确认删除 '+currentRow.name+' ？注：已分配到该学校的设备将转移到上级代理。')==true){
		var url='../sys/removeschool';
		
		var param = 'id='+id+"&adminId="+currentRow.adminId;
		AjaxUtils(url,'GET',param,function(data){
			if(data){
				//data = jQuery.parseJSON(data);
	    		//$("#notice-tip").show();
	    		//$("#notice-span").html(data.data.notice);
	    		
	    		alert(data.data.notice);
	    		
	    		table.ajax.reload();
	    		//loadPage('getschool');
     		}else{
     			alert('操作失败！');
     		}
		});
	}
}
</script>
